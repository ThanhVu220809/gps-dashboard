<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõ∞Ô∏è GPS Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui;background:#0f172a;color:#f1f5f9}
    .header{background:#1e293b;padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #334155}
    .header h1{font-size:1.5rem}
    .status{padding:6px 14px;border-radius:20px;font-size:0.85rem;font-weight:600}
    .online{background:rgba(34,197,94,0.2);color:#22c55e;border:1px solid #22c55e}
    .offline{background:rgba(239,68,68,0.2);color:#ef4444;border:1px solid #ef4444}
    .lastknown{background:rgba(234,179,8,0.2);color:#eab308;border:1px solid #eab308}
    .container{display:grid;grid-template-columns:1fr 320px;height:calc(100vh - 65px)}
    @media(max-width:768px){.container{grid-template-columns:1fr;grid-template-rows:1fr auto}}
    #map{width:100%;height:100%}
    .sidebar{background:#1e293b;padding:16px;overflow-y:auto}
    .card{background:#0f172a;border-radius:12px;padding:16px;margin-bottom:12px}
    .card-title{font-size:0.7rem;color:#64748b;text-transform:uppercase;margin-bottom:8px}
    .stats{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .stat{text-align:center;padding:10px;background:#1e293b;border-radius:8px}
    .stat-label{font-size:0.65rem;color:#64748b}
    .stat-value{font-size:1.2rem;font-weight:700;color:#3b82f6}
    .stat-value.green{color:#22c55e}
    .coord{font-family:monospace;padding:10px;background:#1e293b;border-radius:8px;text-align:center;color:#94a3b8}
    .time{text-align:center;font-size:0.75rem;color:#64748b;margin-top:8px}
    input{width:100%;padding:10px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#fff;margin-top:12px}
    button{width:100%;padding:12px;background:#3b82f6;border:none;border-radius:8px;color:#fff;font-weight:600;cursor:pointer;margin-top:8px}
  </style>
</head>
<body>
<div class="header">
  <h1>üõ∞Ô∏è GPS Tracker</h1>
  <div id="status" class="status offline">ƒêang k·∫øt n·ªëi...</div>
</div>
<div class="container">
  <div id="map"></div>
  <div class="sidebar">
    <div class="card">
      <div class="card-title">üìç V·ªã tr√≠</div>
      <div class="coord" id="coord">ƒêang t·∫£i...</div>
      <div class="time" id="time">--</div>
    </div>
    <div class="card">
      <div class="card-title">üìä Th√¥ng s·ªë</div>
      <div class="stats">
        <div class="stat"><div class="stat-label">T·ªëc ƒë·ªô</div><div class="stat-value" id="speed">--</div></div>
        <div class="stat"><div class="stat-label">V·ªá tinh</div><div class="stat-value green" id="sats">--</div></div>
        <div class="stat"><div class="stat-label">S√≥ng</div><div class="stat-value" id="csq">--</div></div>
        <div class="stat"><div class="stat-label">Tr·∫°ng th√°i</div><div class="stat-value" id="gps">--</div></div>
      </div>
    </div>
    <input id="url" placeholder="Worker URL" value="">
    <button onclick="save()">üíæ L∆∞u URL</button>
  </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===== CONFIG =====
const DEFAULT_URL = 'https://gps-tracker.YOUR-SUBDOMAIN.workers.dev';
const DEVICE_ID = 'device_01';
let workerUrl = localStorage.getItem('workerUrl') || DEFAULT_URL;
document.getElementById('url').value = workerUrl;
// ===== MAP SETUP =====
const map = L.map('map').setView([10.823, 106.629], 15);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '¬© OpenStreetMap ¬© CARTO', maxZoom: 19
}).addTo(map);
// Custom markers
const greenIcon = L.divIcon({html:'<div style="background:#22c55e;border:3px solid #fff;border-radius:50%;width:20px;height:20px;box-shadow:0 0 10px rgba(34,197,94,0.8)"></div>',iconSize:[20,20],iconAnchor:[10,10]});
const greyIcon = L.divIcon({html:'<div style="background:#64748b;border:3px solid #fff;border-radius:50%;width:20px;height:20px"></div>',iconSize:[20,20],iconAnchor:[10,10]});
const yellowIcon = L.divIcon({html:'<div style="background:#eab308;border:3px solid #fff;border-radius:50%;width:20px;height:20px;box-shadow:0 0 10px rgba(234,179,8,0.6)"></div>',iconSize:[20,20],iconAnchor:[10,10]});
let marker = L.marker([10.823, 106.629], {icon: greyIcon}).addTo(map);
// ===== FUNCTIONS =====
function updateStatus(isOnline, status) {
  const el = document.getElementById('status');
  const gpsEl = document.getElementById('gps');
  if (status === 'LAST_KNOWN') {
    el.className = 'status lastknown'; el.textContent = 'Last Known';
    gpsEl.textContent = 'LK'; gpsEl.style.color = '#eab308';
    marker.setIcon(yellowIcon);
  } else if (isOnline) {
    el.className = 'status online'; el.textContent = 'Online';
    gpsEl.textContent = 'LIVE'; gpsEl.style.color = '#22c55e';
    marker.setIcon(greenIcon);
  } else {
    el.className = 'status offline'; el.textContent = 'Offline';
    gpsEl.textContent = 'OFF'; gpsEl.style.color = '#ef4444';
    marker.setIcon(greyIcon);
  }
}
async function fetchData() {
  try {
    const res = await fetch(`${workerUrl}/api/location?deviceId=${DEVICE_ID}`);
    if (!res.ok) { updateStatus(false); return; }
    const d = await res.json();
    
    marker.setLatLng([d.lat, d.lng]);
    document.getElementById('coord').textContent = `${d.lat.toFixed(6)}, ${d.lng.toFixed(6)}`;
    document.getElementById('time').textContent = `${d.ageSeconds}s ago`;
    document.getElementById('speed').textContent = (d.speed || 0).toFixed(1);
    document.getElementById('sats').textContent = d.satellites || 0;
    document.getElementById('csq').textContent = (d.csq || 0) + '/31';
    
    updateStatus(d.ageSeconds < 300, d.status);
  } catch (e) {
    console.error(e);
    updateStatus(false);
  }
}
function save() {
  workerUrl = document.getElementById('url').value.trim();
  localStorage.setItem('workerUrl', workerUrl);
  fetchData();
}
// ===== INIT =====
fetchData();
setInterval(fetchData, 5000);
</script>
</body>
</html>
